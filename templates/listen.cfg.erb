listen <%= name %> <%= ip %>:<%= port %>
	mode <%= mode %>
	balance <%= balance %>
<% if maxconn != "" -%>
	maxconn <%= maxconn %>
<% end -%>
<% if hash_type == "default" -%>
<% servers.each do |server| -%>
	server <%= server['name'] %> <%= server['ip'] %>:<%= port %><% if server['maxconn'] -%> maxconn <%= server['maxconn'] %><% end -%><% if server['cookie'] -%> cookie <%= server['cookie'] %><% end -%><% if server['check'] -%> check inter <%= server['check_inter'] %> fail <%= server['check_fail'] %><% end %>
<% end -%>
<% elsif hash_type == "mcollective" -%>
<% nodes = Puppet::Util::MongoQuery.instance.find_nodes(query) -%>
<% nodes.each do |node| -%>
	server <%= node['facts']['hostname'] %> <%= node['facts']['ipaddress'] %>:<%= port %><% if server_maxconn != "" -%> maxconn <%= server_maxconn %><% end -%><% if server_cookie -%> cookie <%= server['facts']['hostname'] %><% end -%><% if server_check -%> check inter <%= server_check_inter %> fail <%= server_check_fail %><% end %>
<% end -%>
<% end -%>
<% options.each do |option| -%>
	option <%= option %>
<% end %>

